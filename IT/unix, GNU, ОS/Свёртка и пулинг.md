Мы поняли основную цель [[свёрточный слой|свёрточных слоев]] — найти важные особенности изображения (например, границы объектов). Мы будем называть их **признаками**. Сверточные слои нейросети делают специальные операции, чтобы найти признаки. Основные из них — это свертка и пулинг.
## Свертка
Операция свертки применяет фильтры (ядра) к данным. Что такое фильтр? Это маленькая матрица с весами (например, 3×3 или 5×5), которая «скользит» по изображению, пытаясь найти признаки.

Возьмем такой фильтр 3×3:
![[IT/files/image-12.png]]
Для простоты возьмем «изображение» 5 на 5 пикселей, и закодируем каждый пиксель числами от 0 до 3. Вот так выглядит применение фильтра:
![[image-10.png]]
Если в полносвязной нейросети нейроны принимали все пиксели изображения сразу и строили линейную комбинацию, то фильтр считает комбинации для маленьких кусочков изображения: 3 на 3 пикселя.

Мы накладываем фильтр на изображение, перемножаем все девять пар чисел и складываем произведения. Пройдясь так по всему изображению, мы получаем новую матрицу из этих сумм. Она называется картой признаков.

Например, когда фильтр стоял в левом углу матрицы, мы получили сумму 3×1 + 3×1 + 2×1 + 0×1 + 0×1 + 3×1 + 0×1 + 1×1 + 2×1 = 14. Значит, в левом верхнем углу получившейся матрицы будет число 14.

Рассмотрим на примере другого фильтра, который **ищет вертикальные границы**.
![[image-11.png]]
Веса левого столбца положительны, правого — отрицательны, а средний игнорируется. Что будет, если применить такой фильтр к изображению? Например, на однородном рисунке белого цвета (кодируем числом 255):
![[Pasted image 20250907114752.png]]255×1 + 255×0 + 255×(-1) + 255×1 + 255×0 + 255×(-1) + 255×1 + 255×0 + 255×(-1) = 0.

Если все числа (пиксели изображения) одинаковые, то результат применения фильтра равен 0: левый столбец в сумму входит со знаком плюс, а правый — со знаком минус.
А если на картинке есть два цвета? Добавим справа черную полосу (кодируем числом 0).
![[image-5.png]]
255×1 + 255×0 + 0×(-1) + 255×1 + 255×0 + 0×(-1) + 255×1 + 255×0 + 0×(-1) = 255 + 255 + 255 = 765.

Из-за того, что в левом и правом столбце разные числа, общая сумма больше не равна нулю. Для любого изображения 3×3 этот фильтр покажет, будут ли левый и правый столбцы одинакового цвета.

---
Хорошо, с маленьким кусочком изображения мы поняли. Но фильтр ведь может «ходить» по большому изображению, высчитывая такие суммы для каждого своего положения. Что нам это дает? Рассмотрим на матрице побольше.

Вот «изображение» 3 на 6, у которого левая половина — белого цвета, а правая — черного:
![[image-6.png]]
Левый столбец берем со знаком плюс, правый — со знаком минус. Значит, после применения фильтра мы получим такую карту признаков: ![[image-7.png|293x86]]
Если бы матрица изображения была шире, то в карту признаков бы добавились нули слева и справа, а числа 765 остались бы только в середине — там, где от белого цвета мы переходим к черному.

Наш фильтр отыскивает **вертикальные границы** на изображении.

Сейчас, правда, карта признаков другой формы, чем оригинальное изображение. Это не очень удобно: вроде бы и поняли, что есть граница цвета в середине, а вроде и неочевидно, где именно она пролегает.

Чтобы результат был такого же размера, что и матрица изображения, можно по краям к ней добавить нули:
![[image-8.png]]
С паддингом карта признаков будет выглядеть так:
![[image-9.png]]Теперь мы видим, что свертка нашла вертикальную линию **ровно посередине** изображения! Числа в левом столбце нас не интересуют — они символизируют границу самой картинки.

Есть и другие настройки свертки. Например, фильтр можно двигать по изображению с шагом, перепрыгивая через отдельные клетки, если мы не боимся пропустить что-то важное. Это делает свертку более быстрой.

---
Цветные изображения представлять сложнее. Вектора черно-белых изображений мы раньше представляли в виде специального объекта линейной алгебры: [[тензор]]а. А для цветных изображений используется тензор с тремя каналами. Этот объект похож на [[вектор]] или матрицу (в зависимости от размерности), но вместо одного кода пикселя мы храним **три числа в трех каналах**: оттенки красного, зеленого и синего цветов.

Фильтры свертки могут работать с разными каналами:
![[image-11.png]]
А дальше мы сложим эти три карты, чтобы получить общую:
![[image-13.png]]
Каждый фильтр будет искать конкретные признаки. Первый слой сети может выделять горизонтальные и вертикальные края. Более глубокие слои — комбинации краев: углы, текстуры, сложные структуры.
Их параметры подбираются при **обучении нейросети**. В начале обучения мы создаем фильтры со случайными числами, а в процессе — изменяем их с помощью метода обратного распространения ошибки, так же, как делали с параметрами нейронов в полносвязной сети.

Для [[Свёрточная нейросеть|сверточной нейросети]] обучение — это **подбор фильтров**. ([[нейронная сеть, нейросеть]])
Мы разобрали, как строить карты признаков для небольших примеров. Но как они выглядят для реальных изображений?
Открой [тренажер по работе со сверткой](https://yastatic.net/s3/lyceum/files/0e9ee616-19e1-438a-97fa-83d0592a50b9/upload.html) и попробуй применить разные фильтры к картинкам.

---
## пуллинг 
Другая операция, которая используется в сверточных нейросетях, называется пулинг.
Это очень простая операция: мы разбиваем нашу матрицу на квадраты (размером 2×2 или 3×3) и заменяем каждый квадрат на его максимальное ([[Max Pooling]]) или среднее значение ([[Average Pooling]]).
Таким образом можно сохранить важную информацию о матрице, уменьшив ее размер вдвое или втрое.
[[свёрточный слой|Сверточные слои]] сети обычно состоят из чередующихся слоев свертки и пулинга.